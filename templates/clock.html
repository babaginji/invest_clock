<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>人的資本時計</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="light-theme">
<div class="container">

    <!-- 誕生日入力ボックス -->
    <div id="birthdayBox" class="birthday-box">
        <div class="select-row">
            <select id="birthYear"></select><label>年</label>
        </div>
        <div class="select-row">
            <select id="birthMonth"></select><label>月</label>
        </div>
        <div class="select-row">
            <select id="birthDay"></select><label>日</label>
        </div>
        <button id="saveBirthdayBtn">保存</button>

        <div class="theme-switch">
            <span id="lightBtn" class="theme-btn">□</span>
            <span id="darkBtn" class="theme-btn">■</span>
        </div>
    </div>

    <!-- 右上の丸 -->
    <div id="birthdayToggle" class="birthday-toggle">○</div>

    <!-- 人的資本表示 -->
    <h1 id="timeValue">人的資本: ¥0 / h</h1>

    <!-- 時計 -->
    <div class="clock-wrapper">
        <canvas id="clockCanvas" width="320" height="320"></canvas>
        <div id="coinContainer"></div>
    </div>

    <!-- 84歳時点総資産 -->
    <h2 id="totalValue">84歳時点総資産: ¥0</h2>

</div>

<script>
const TARGET_AGE = 84;
const ANNUAL_INTEREST = 0.07;
const COIN_FADE_TIME = 2000;
const HOURS_PER_DAY = 24;

let birthDate = null;
let totalAt84 = 0;
let totalValue = 0;

function initBirthdaySelectors() {
    const ySel = document.getElementById('birthYear');
    const mSel = document.getElementById('birthMonth');
    const dSel = document.getElementById('birthDay');
    const thisYear = new Date().getFullYear();
    for (let y = thisYear; y >= 1900; y--) { let opt = document.createElement('option'); opt.value = y; opt.text = y; ySel.appendChild(opt); }
    for (let m = 1; m <= 12; m++) { let opt = document.createElement('option'); opt.value = m; opt.text = m; mSel.appendChild(opt); }
    for (let d = 1; d <= 31; d++) { let opt = document.createElement('option'); opt.value = d; opt.text = d; dSel.appendChild(opt); }
}

// ---------------------------
// 日付計算
// ---------------------------
function getAgeAndRemainingDays(birth) {
    const today = new Date();
    const birthTime = new Date(birth.getFullYear(), birth.getMonth(), birth.getDate());
    let ageYears = today.getFullYear() - birthTime.getFullYear();
    let ageDays = Math.floor((today - new Date(birthTime.getFullYear() + ageYears, birthTime.getMonth(), birthTime.getDate())) / (1000 * 60 * 60 * 24));
    if (ageDays < 0) { ageYears--; ageDays += Math.round(365.25); }

    const targetDate = new Date(birth.getFullYear() + TARGET_AGE, birth.getMonth(), birth.getDate());
    let remainingDaysTotal = Math.floor((targetDate - today) / (1000 * 60 * 60 * 24));
    const remainingYears = Math.floor(remainingDaysTotal / 365.25);
    const remainingDays = remainingDaysTotal - Math.floor(remainingYears * 365.25);

    return { ageYears, ageDays, remainingYears, remainingDays };
}

// ---------------------------
// 人的資本計算
// ---------------------------
function computeCurrentHumanCapital() {
    if (!birthDate) return 0;
    const { remainingYears, remainingDays } = getAgeAndRemainingDays(birthDate);
    const dayRate = Math.pow(1 + ANNUAL_INTEREST, 1 / 365) - 1;
    let capital = 1; // 現在価値基準 = 1
    capital *= Math.pow(1 + ANNUAL_INTEREST, remainingYears); // 年利分
    capital *= Math.pow(1 + dayRate, remainingDays); // 日利分
    // 1時間あたりに換算
    return capital;
}

// ---------------------------
// 時計描画
// ---------------------------
function drawClock() {
    const canvas = document.getElementById('clockCanvas');
    const ctx = canvas.getContext('2d');
    const radius = canvas.height / 2;
    ctx.translate(radius, radius);
    setInterval(() => {
        drawFace(ctx, radius);
        drawTime(ctx, radius);
    }, 1000);
}

function drawFace(ctx, radius) {
    ctx.clearRect(-radius, -radius, radius * 2, radius * 2);
    ctx.beginPath();
    ctx.arc(0, 0, radius - 2, 0, 2 * Math.PI);
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg-color');
    ctx.fill();
    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--text-color');
    ctx.lineWidth = radius * 0.05;
    ctx.stroke();

    for (let num = 1; num <= 12; num++) {
        const ang = num * Math.PI / 6;
        ctx.beginPath();
        ctx.moveTo(radius * 0.88 * Math.sin(ang), -radius * 0.88 * Math.cos(ang));
        ctx.lineTo(radius * 0.95 * Math.sin(ang), -radius * 0.95 * Math.cos(ang));
        ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--text-color');
        ctx.lineWidth = 2; ctx.stroke();
    }
}

function drawTime(ctx, radius) {
    const now = new Date();
    let hour = now.getHours() % 12;
    let minute = now.getMinutes();
    let second = now.getSeconds();

    hour = (hour * Math.PI / 6) + (minute * Math.PI / (6 * 60)) + (second * Math.PI / (360 * 60));
    drawHand(ctx, hour, radius * 0.5, radius * 0.07);

    minute = (minute * Math.PI / 30) + (second * Math.PI / (30 * 60));
    drawHand(ctx, minute, radius * 0.7, radius * 0.07);

    second = second * Math.PI / 30;
    drawHand(ctx, second, radius * 0.9, radius * 0.02, 'red');

    // コインアニメーション
    if (birthDate) {
        const perHour = computeCurrentHumanCapital() * 2600; // 現在1時間あたりの価値
        const perSecond = perHour / 3600;
        startCoinAnimation(perSecond);
        totalValue += perSecond;
        document.getElementById('totalValue').textContent = `84歳時点総資産: ¥${totalValue.toFixed(0)}`;
        document.getElementById('timeValue').textContent = `人的資本: ¥${perHour.toFixed(0)} / h`;
    }
}

function drawHand(ctx, pos, length, width, color = null) {
    ctx.beginPath();
    ctx.lineWidth = width;
    ctx.lineCap = "round";
    ctx.strokeStyle = color || getComputedStyle(document.body).getPropertyValue('--text-color');
    ctx.moveTo(0, 0);
    ctx.rotate(pos);
    ctx.lineTo(0, -length);
    ctx.stroke();
    ctx.rotate(-pos);
}

function startCoinAnimation(valuePerSecond) {
    const coinContainer = document.getElementById('coinContainer');
    const coin = document.createElement('div');
    coin.className = 'coin';
    coin.textContent = `¥${valuePerSecond.toFixed(2)}`;
    coinContainer.appendChild(coin);

    const offsetX = (Math.random() - 0.5) * 40;
    coin.style.left = `calc(50% + ${offsetX}px)`;

    coin.animate([
        { transform: 'translateY(0)', opacity: 1 },
        { transform: 'translateY(100px)', opacity: 0 }
    ], {
        duration: COIN_FADE_TIME,
        easing: 'ease-out'
    });

    setTimeout(() => { coinContainer.removeChild(coin); }, COIN_FADE_TIME);
}

// ---------------------------
// 誕生日保存
// ---------------------------
function saveBirthday() {
    const y = parseInt(document.getElementById('birthYear').value);
    const m = parseInt(document.getElementById('birthMonth').value) - 1;
    const d = parseInt(document.getElementById('birthDay').value);
    if (!y || !m || !d) return alert("正しい日付を入力してください");
    birthDate = new Date(y, m, d);
    localStorage.setItem('userBirthday', birthDate.toISOString());
    hideBirthdayBox();
}

function showBirthdayBox() { document.getElementById('birthdayBox').style.display = 'flex'; }
function hideBirthdayBox() { document.getElementById('birthdayBox').style.display = 'none'; }

// ---------------------------
// イベント登録
// ---------------------------
window.onload = function() {
    initBirthdaySelectors();
    const toggle = document.getElementById('birthdayToggle');
    toggle.addEventListener('click', showBirthdayBox);
    document.getElementById('saveBirthdayBtn').addEventListener('click', saveBirthday);

    const saved = localStorage.getItem('userBirthday');
    if (saved) { birthDate = new Date(saved); hideBirthdayBox(); }
    else { showBirthdayBox(); }

    document.addEventListener('click', function(e){
        const box = document.getElementById('birthdayBox');
        const toggle = document.getElementById('birthdayToggle');
        if (!box.contains(e.target) && !toggle.contains(e.target)) hideBirthdayBox();
    });

    document.getElementById('lightBtn').addEventListener('click', ()=>{ document.body.className='light-theme'; });
    document.getElementById('darkBtn').addEventListener('click', ()=>{ document.body.className='dark-theme'; });

    drawClock();
};
</script>
</body>
</html>
