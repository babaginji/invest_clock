<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人的資本時計</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="light-theme">

<div class="container">
    <!-- 右上の丸ボタン -->
    <div id="birthdayToggle" class="birthday-toggle">○</div>

    <!-- 半透明ボックス：生年月日入力＋テーマ切替 -->
    <div id="birthdayBox" class="birthday-box">
        <!-- 年月日セレクト -->
        <div class="select-row">
            <select id="birthYear"></select>
            <select id="birthMonth"></select>
            <select id="birthDay"></select>
        </div>
        <button id="saveBirthdayBtn">保存</button>

        <!-- 白黒テーマ切替 -->
        <div class="theme-switch">
            <div id="lightBtn" class="theme-btn">□</div>
            <div id="darkBtn" class="theme-btn">■</div>
        </div>
    </div>

    <!-- 現在価値表示 -->
    <h1 id="timeValue">現在価値: ¥0 / h</h1>

    <!-- 時計 -->
    <div class="clock-wrapper">
        <canvas id="clockCanvas" width="300" height="300"></canvas>
        <div id="coinContainer"></div>
    </div>

    <!-- 総人的資本 -->
    <div id="totalValue">18歳からの総人的資本: ¥0</div>
</div>

<script>
/* ---------------------------
   定数
--------------------------- */
const TARGET_AGE = 84;           // 84歳での金融資産
const ANNUAL_INTEREST = 0.07;    // 年利7%
const COIN_FADE_TIME = 2000;     // コインフェード時間(ms)
const HOURLY_BASE_VALUE = 2600;  // 現在時点1時間あたりの価値
let birthDate = null;             // ユーザー生年月日

/* ---------------------------
   誕生日セレクト初期化
--------------------------- */
function initBirthdaySelectors() {
    const now = new Date();
    const ySelect = document.getElementById('birthYear');
    const mSelect = document.getElementById('birthMonth');
    const dSelect = document.getElementById('birthDay');

    for (let y = now.getFullYear(); y >= 1900; y--) {
        const opt = document.createElement('option');
        opt.value = y; opt.textContent = y;
        ySelect.appendChild(opt);
    }
    for (let m = 1; m <= 12; m++) {
        const opt = document.createElement('option');
        opt.value = m; opt.textContent = m;
        mSelect.appendChild(opt);
    }
    for (let d = 1; d <= 31; d++) {
        const opt = document.createElement('option');
        opt.value = d; opt.textContent = d;
        dSelect.appendChild(opt);
    }
}

/* ---------------------------
   年齢・残り年・日数計算
--------------------------- */
function getAgeAndRemainingDays(birth) {
    const now = new Date();
    let age = now.getFullYear() - birth.getFullYear();
    let monthDiff = now.getMonth() - birth.getMonth();
    let dayDiff = now.getDate() - birth.getDate();
    if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) age--;
    
    // 残り期間
    const targetDate = new Date(birth.getFullYear() + TARGET_AGE, birth.getMonth(), birth.getDate());
    let diffMs = targetDate - now;
    let diffDaysTotal = Math.floor(diffMs / (1000*60*60*24));
    let remainingYears = Math.floor(diffDaysTotal / 365);
    let remainingDays = diffDaysTotal % 365;
    return { age, remainingYears, remainingDays };
}

/* ---------------------------
   現在の人的資本（1時間あたり）
--------------------------- */
function computeCurrentHumanCapital() {
    if (!birthDate) return 0;
    const { remainingYears, remainingDays } = getAgeAndRemainingDays(birthDate);
    const dayRate = Math.pow(1 + ANNUAL_INTEREST, 1/365) - 1;
    let capital = 1; // 84歳時点の価値を1として現在価値に割り戻す
    capital *= Math.pow(1 + ANNUAL_INTEREST, remainingYears);
    capital *= Math.pow(1 + dayRate, remainingDays);
    return capital * HOURLY_BASE_VALUE;
}

/* ---------------------------
   18歳から現在までの総人的資本
--------------------------- */
function computeTotalHumanCapital() {
    if (!birthDate) return 0;
    const adultDate = new Date(birthDate.getFullYear() + 18, birthDate.getMonth(), birthDate.getDate());
    const now = new Date();
    if (now < adultDate) return 0;
    const totalMs = now - adultDate;
    const totalHours = totalMs / (1000*60*60);
    const currentPerHour = computeCurrentHumanCapital();
    return totalHours * currentPerHour;
}

/* ---------------------------
   生年月日保存
--------------------------- */
function saveBirthday() {
    const y = parseInt(document.getElementById('birthYear').value);
    const m = parseInt(document.getElementById('birthMonth').value) - 1;
    const d = parseInt(document.getElementById('birthDay').value);
    if (!y || !m || !d) return alert("正しい日付を入力してください");
    birthDate = new Date(y, m, d);
    localStorage.setItem('userBirthday', birthDate.toISOString());
    hideBirthdayBox();
    updateValues();
}

/* ---------------------------
   誕生日ボックス表示/非表示
--------------------------- */
function showBirthdayBox() { document.getElementById('birthdayBox').style.display = 'flex'; }
function hideBirthdayBox() { document.getElementById('birthdayBox').style.display = 'none'; }

/* ---------------------------
   現在価値・総資産更新
--------------------------- */
function updateValues() {
    const current = computeCurrentHumanCapital();
    document.getElementById('timeValue').textContent = `現在価値: ¥${current.toFixed(0)} / h`;
    const total = computeTotalHumanCapital();
    document.getElementById('totalValue').textContent = `18歳からの総人的資本: ¥${total.toFixed(0)}`;
}

/* ---------------------------
   コインアニメーション
--------------------------- */
function startCoinAnimation() {
    const coinContainer = document.getElementById('coinContainer');
    const coin = document.createElement('div');
    coin.className = 'coin';
    coin.textContent = `¥${computeCurrentHumanCapital().toFixed(0)}`;
    coinContainer.appendChild(coin);

    const offsetX = (Math.random() - 0.5) * 40;
    coin.style.left = `calc(50% + ${offsetX}px)`;

    coin.animate([
        { transform: 'translateY(0)', opacity: 1 },
        { transform: 'translateY(100px)', opacity: 0 }
    ], {
        duration: COIN_FADE_TIME,
        easing: 'ease-out'
    });

    setTimeout(() => coinContainer.removeChild(coin), COIN_FADE_TIME);
}

/* ---------------------------
   時計描画
--------------------------- */
function drawClock() {
    const canvas = document.getElementById('clockCanvas');
    const ctx = canvas.getContext('2d');
    const radius = canvas.height / 2;
    ctx.translate(radius, radius);
    setInterval(() => {
        drawFace(ctx, radius);
        drawTime(ctx, radius);
        startCoinAnimation();
    }, 1000);
}

function drawFace(ctx, radius) {
    ctx.clearRect(-radius, -radius, radius*2, radius*2);
    ctx.beginPath();
    ctx.arc(0, 0, radius, 0, 2*Math.PI);
    ctx.fillStyle = 'var(--bg-color)';
    ctx.fill();
    ctx.strokeStyle = '#333';
    ctx.lineWidth = radius*0.05;
    ctx.stroke();

    // 目盛線
    for(let num=1; num<=12; num++){
        const ang = num * Math.PI / 6;
        const innerR = radius*0.88;
        const outerR = radius*0.95;
        ctx.beginPath();
        ctx.moveTo(innerR * Math.sin(ang), -innerR * Math.cos(ang));
        ctx.lineTo(outerR * Math.sin(ang), -outerR * Math.cos(ang));
        ctx.stroke();
    }

    // 数字
    ctx.font = radius*0.15 + "px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    for (let num=1; num<=12; num++){
        const ang = num * Math.PI / 6;
        ctx.rotate(ang);
        ctx.translate(0, -radius*0.75);
        ctx.rotate(-ang);
        ctx.fillStyle = 'var(--text-color)';
        ctx.fillText(num.toString(), 0, 0);
        ctx.rotate(ang);
        ctx.translate(0, radius*0.75);
        ctx.rotate(-ang);
    }
}

function drawTime(ctx, radius) {
    const now = new Date();
    let hour = now.getHours()%12;
    let minute = now.getMinutes();
    let second = now.getSeconds();

    hour = (hour*Math.PI/6) + (minute*Math.PI/(6*60)) + (second*Math.PI/(360*60));
    drawHand(ctx, hour, radius*0.5, radius*0.07);

    minute = (minute*Math.PI/30) + (second*Math.PI/(30*60));
    drawHand(ctx, minute, radius*0.7, radius*0.07);

    second = second*Math.PI/30;
    drawHand(ctx, second, radius*0.9, radius*0.02, 'red');
}

function drawHand(ctx, pos, length, width, color='black') {
    ctx.beginPath();
    ctx.lineWidth = width;
    ctx.lineCap = "round";
    ctx.strokeStyle = color;
    ctx.moveTo(0,0);
    ctx.rotate(pos);
    ctx.lineTo(0, -length);
    ctx.stroke();
    ctx.rotate(-pos);
}

/* ---------------------------
   ウィンドウロード時
--------------------------- */
window.onload = function() {
    initBirthdaySelectors();
    const toggle = document.getElementById('birthdayToggle');
    toggle.addEventListener('click', showBirthdayBox);
    document.getElementById('saveBirthdayBtn').addEventListener('click', saveBirthday);

    // 保存済み生年月日を読み込み
    const saved = localStorage.getItem('userBirthday');
    if (saved) { birthDate = new Date(saved); hideBirthdayBox(); }
    else { showBirthdayBox(); }

    // 外部クリックでボックス非表示
    document.addEventListener('click', function(e){
        const box = document.getElementById('birthdayBox');
        if (!box.contains(e.target) && !toggle.contains(e.target)) hideBirthdayBox();
    });

    // テーマ切替
    document.getElementById('lightBtn').addEventListener('click', ()=>{ document.body.className='light-theme'; });
    document.getElementById('darkBtn').addEventListener('click', ()=>{ document.body.className='dark-theme'; });

    updateValues();
    drawClock();
};
</script>
</body>
</html>
