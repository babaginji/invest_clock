<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>複利時計</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container">
    <h2>人的資本（1時間あたり）</h2>

    <!-- 年月日入力ボックス -->
    <div id="birthdayBox" class="birthday-box">
        <div class="select-row">
            <select id="yearSelect"></select>
            <select id="monthSelect"></select>
            <select id="daySelect"></select>
        </div>
        <button id="saveBirthdayBtn">保存</button>
        <div class="theme-switch">
            <div id="whiteBtn" class="theme-btn">□</div>
            <div id="blackBtn" class="theme-btn">■</div>
        </div>
    </div>

    <!-- 右上丸ボタン -->
    <div id="birthdayToggle" class="birthday-toggle">○</div>

    <!-- 人的資本表示 -->
    <h1 id="timeValue">現在価値: ¥0 / h</h1>

    <!-- 総資産表示 -->
    <h3 id="totalValue">総人的資本: ¥0</h3>

    <!-- 時計 -->
    <div class="clock-wrapper">
        <canvas id="clockCanvas" width="300" height="300"></canvas>
        <div id="coinContainer"></div>
    </div>
</div>

<script>
// ---------------------------
// 定数
// ---------------------------
const TARGET_AGE = 84;
const ANNUAL_INTEREST = 0.07;
const SECONDS_PER_HOUR = 3600;
const START_AGE = 18;
const DAILY_CONTRIBUTION = 62400;
const COIN_FADE_TIME = 2000;

// ---------------------------
// ユーティリティ
// ---------------------------
function calcAge(birthday) {
    const now = new Date();
    let age = now.getFullYear() - birthday.getFullYear();
    let m = now.getMonth() - birthday.getMonth();
    let d = now.getDate() - birthday.getDate();
    if (m < 0 || (m === 0 && d < 0)) age--;
    return {years: age, months: m, days: d};
}

function daysBetween(date1, date2){
    const diff = date2 - date1;
    return diff / (1000*60*60*24);
}

// ---------------------------
// 人的資本計算
// ---------------------------
function calculateHumanCapital(birthday){
    const now = new Date();
    const ageObj = calcAge(birthday);

    const futureDate = new Date(birthday.getFullYear()+TARGET_AGE, birthday.getMonth(), birthday.getDate());
    const diffMs = futureDate - now;
    const diffYears = diffMs / (1000*60*60*24*365.25);
    const fullYears = Math.floor(diffYears);
    const extraDays = (diffYears - fullYears) * 365.25;

    let value = 1; // 基準1円
    value *= Math.pow(1+ANNUAL_INTEREST, fullYears);
    value *= Math.pow(1 + ANNUAL_INTEREST/365, extraDays);

    // 1時間あたり
    return value * 2600;
}

// ---------------------------
// 総人的資本計算
// ---------------------------
function calculateTotalHumanCapital(birthday){
    const startDate = new Date(birthday.getFullYear()+START_AGE, birthday.getMonth(), birthday.getDate());
    const now = new Date();
    let diffDays = daysBetween(startDate, now);
    if(diffDays < 0) diffDays = 0;
    let total = DAILY_CONTRIBUTION * diffDays;
    // 簡易複利計算: 年利7%
    return total * Math.pow(1+ANNUAL_INTEREST, diffDays/365);
}

// ---------------------------
// 時計描画
// ---------------------------
function drawClock(){
    const canvas = document.getElementById('clockCanvas');
    const ctx = canvas.getContext('2d');
    const radius = canvas.height/2;
    ctx.translate(radius, radius);

    function drawFace(){
        ctx.clearRect(-radius,-radius,radius*2,radius*2);
        ctx.beginPath();
        ctx.arc(0,0,radius,0,2*Math.PI);
        ctx.fillStyle = 'white';
        ctx.fill();
        ctx.strokeStyle = '#333';
        ctx.lineWidth = radius*0.05;
        ctx.stroke();

        for(let num=1;num<=12;num++){
            const ang = num*Math.PI/6;
            ctx.beginPath();
            const innerR = radius*0.88;
            const outerR = radius*0.95;
            ctx.moveTo(innerR*Math.sin(ang),-innerR*Math.cos(ang));
            ctx.lineTo(outerR*Math.sin(ang),-outerR*Math.cos(ang));
            ctx.stroke();
        }

        ctx.font = radius*0.15 + "px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        for(let num=1;num<=12;num++){
            const ang = num*Math.PI/6;
            ctx.rotate(ang);
            ctx.translate(0,-radius*0.75);
            ctx.rotate(-ang);
            ctx.fillText(num.toString(),0,0);
            ctx.rotate(ang);
            ctx.translate(0,radius*0.75);
            ctx.rotate(-ang);
        }
    }

    function drawHands(hourVal){
        const now = new Date();
        let hour = now.getHours()%12;
        let minute = now.getMinutes();
        let second = now.getSeconds();

        hour = (hour*Math.PI/6)+(minute*Math.PI/(6*60))+(second*Math.PI/(360*60));
        drawHand(hour,radius*0.5,radius*0.07);

        minute = (minute*Math.PI/30)+(second*Math.PI/(30*60));
        drawHand(minute,radius*0.7,radius*0.07);

        second = second*Math.PI/30;
        drawHand(second,radius*0.9,radius*0.02,'red');
    }

    function drawHand(pos,length,width,color='black'){
        ctx.beginPath();
        ctx.lineWidth = width;
        ctx.lineCap = 'round';
        ctx.strokeStyle = color;
        ctx.moveTo(0,0);
        ctx.rotate(pos);
        ctx.lineTo(0,-length);
        ctx.stroke();
        ctx.rotate(-pos);
    }

    setInterval(()=>{
        drawFace();
        drawHands();
        spawnCoin();
    },1000);
}

// ---------------------------
// コインアニメーション
// ---------------------------
function spawnCoin(){
    const birthday = getSavedBirthday();
    const valuePerHour = calculateHumanCapital(birthday);
    const valuePerSecond = valuePerHour/3600;

    // 総資本加算
    const totalEl = document.getElementById('totalValue');
    let total = parseFloat(totalEl.dataset.total || 0);
    total += valuePerSecond;
    totalEl.dataset.total = total;
    totalEl.textContent = '総人的資本: ¥'+total.toFixed(2);

    // コイン生成
    const coinContainer = document.getElementById('coinContainer');
    const coin = document.createElement('div');
    coin.className = 'coin';
    coin.textContent = '¥'+valuePerSecond.toFixed(2);
    coinContainer.appendChild(coin);

    coin.style.left = (Math.random()-0.5)*40 + 'px';
    coin.animate([
        {transform:'translateY(0)',opacity:1},
        {transform:'translateY(100px)',opacity:0}
    ],{duration:2000,easing:'ease-out'});

    setTimeout(()=>coinContainer.removeChild(coin),2000);
}

// ---------------------------
// 誕生日保存
// ---------------------------
function getSavedBirthday(){
    const val = localStorage.getItem('userBirthday');
    if(val) return new Date(val);
    return new Date('2000-01-01');
}

function saveBirthday(){
    const y = parseInt(document.getElementById('yearSelect').value);
    const m = parseInt(document.getElementById('monthSelect').value)-1;
    const d = parseInt(document.getElementById('daySelect').value);
    const birthday = new Date(y,m,d);
    localStorage.setItem('userBirthday',birthday);
    updateValues();
    hideBirthdayBox();
}

// ---------------------------
// UI操作
// ---------------------------
function showBirthdayBox(){document.getElementById('birthdayBox').style.display='flex';}
function hideBirthdayBox(){document.getElementById('birthdayBox').style.display='none';}

document.getElementById('birthdayToggle').addEventListener('click',showBirthdayBox);
document.getElementById('saveBirthdayBtn').addEventListener('click',saveBirthday);
document.addEventListener('click',e=>{
    const box=document.getElementById('birthdayBox');
    const toggle=document.getElementById('birthdayToggle');
    if(!box.contains(e.target) && !toggle.contains(e.target)) hideBirthdayBox();
});

// ---------------------------
// 初期化
// ---------------------------
function populateSelects(){
    const yearSel=document.getElementById('yearSelect');
    for(let y=1900;y<=2025;y++){yearSel.add(new Option(y,y));}
    const monthSel=document.getElementById('monthSelect');
    for(let m=1;m<=12;m++){monthSel.add(new Option(m,m));}
    const daySel=document.getElementById('daySelect');
    for(let d=1;d<=31;d++){daySel.add(new Option(d,d));}
}

function updateValues(){
    const birthday = getSavedBirthday();
    document.getElementById('yearSelect').value = birthday.getFullYear();
    document.getElementById('monthSelect').value = birthday.getMonth()+1;
    document.getElementById('daySelect').value = birthday.getDate();

    const valuePerHour = calculateHumanCapital(birthday);
    document.getElementById('timeValue').textContent = '現在価値: ¥'+valuePerHour.toFixed(2)+' / h';

    const total = calculateTotalHumanCapital(birthday);
    const totalEl = document.getElementById('totalValue');
    totalEl.dataset.total = total;
    totalEl.textContent = '総人的資本: ¥'+total.toFixed(2);
}

// ---------------------------
// ページロード
// ---------------------------
window.onload = function(){
    populateSelects();
    updateValues();
    drawClock();
};
</script>
</body>
</html>
