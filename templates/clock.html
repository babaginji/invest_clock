<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>複利時計</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- 年齢入力ボックス -->
        <div id="ageBox" class="age-box">
            <input type="number" id="ageInput" min="0" max="120" placeholder="年齢を入力">
            <button id="saveAgeBtn">保存</button>
        </div>

        <!-- 右上のトグルボタン -->
        <div id="ageToggle" class="age-toggle">○</div>

        <!-- 現在価値の表示 -->
        <h1 id="timeValue">現在価値: ¥{{ future_value }} / h</h1>

        <!-- 時計とコイン演出 -->
        <div class="clock-wrapper">
            <canvas id="clockCanvas" width="300" height="300"></canvas>
            <div id="coinContainer"></div>
        </div>
    </div>

    <script>
        const TARGET_AGE = 84;
        const ANNUAL_INTEREST = 0.07;
        const CURRENT_HOURLY_VALUE = 2600; // 現在の1時間あたり価値
        const COIN_FADE_TIME = 2000;

        // 年齢から84歳時点の1秒あたり価値を計算
        function calculateFutureValue(age) {
            const yearsToGo = TARGET_AGE - age;
            const currentPerSecond = CURRENT_HOURLY_VALUE / 3600;
            return currentPerSecond * Math.pow(1 + ANNUAL_INTEREST, yearsToGo);
        }

        // 84歳時点の1時間あたり価値を表示
        function updateTimeValue(age) {
            const fv_per_second = calculateFutureValue(age);
            const fv_per_hour = fv_per_second * 3600;
            document.getElementById('timeValue').textContent =
                `現在価値: ¥${fv_per_hour.toFixed(2)} / h`;
        }

        // 年齢保存
        function saveAge() {
            const age = parseInt(document.getElementById('ageInput').value);
            if (!isNaN(age) && age > 0 && age < 120) {
                localStorage.setItem('userAge', age);
                updateTimeValue(age);
                hideAgeBox();
            } else {
                alert("0~120の有効な年齢を入力してください");
            }
        }

        // 年齢入力ボックス表示/非表示
        function showAgeBox() { document.getElementById('ageBox').style.display = 'flex'; }
        function hideAgeBox() { document.getElementById('ageBox').style.display = 'none'; }

        // 外部クリックでボックス非表示
        document.addEventListener('click', function(e){
            const ageBox = document.getElementById('ageBox');
            const toggle = document.getElementById('ageToggle');
            if (!ageBox.contains(e.target) && !toggle.contains(e.target)) {
                hideAgeBox();
            }
        });

        // 時計描画
        function drawClock() {
            const canvas = document.getElementById('clockCanvas');
            const ctx = canvas.getContext('2d');
            const radius = canvas.height / 2;
            ctx.translate(radius, radius);
            setInterval(() => {
                drawFace(ctx, radius);
                drawTime(ctx, radius);
            }, 1000);
        }

        function drawFace(ctx, radius) {
            ctx.clearRect(-radius, -radius, radius*2, radius*2);
            ctx.beginPath();
            ctx.arc(0, 0, radius, 0, 2*Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.strokeStyle = '#333';
            ctx.lineWidth = radius*0.05;
            ctx.stroke();

            // 目盛線
            for (let num=1; num<=12; num++) {
                const ang = num * Math.PI / 6;
                ctx.beginPath();
                const innerRadius = radius*0.88;
                const outerRadius = radius*0.95;
                ctx.moveTo(innerRadius * Math.sin(ang), -innerRadius * Math.cos(ang));
                ctx.lineTo(outerRadius * Math.sin(ang), -outerRadius * Math.cos(ang));
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            // 数字
            ctx.font = radius*0.15 + "px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            for (let num=1; num<=12; num++) {
                const ang = num * Math.PI / 6;
                ctx.rotate(ang);
                ctx.translate(0, -radius*0.75);
                ctx.rotate(-ang);
                ctx.fillText(num.toString(), 0, 0);
                ctx.rotate(ang);
                ctx.translate(0, radius*0.75);
                ctx.rotate(-ang);
            }
        }

        function drawTime(ctx, radius) {
            const now = new Date();
            let hour = now.getHours() % 12;
            let minute = now.getMinutes();
            let second = now.getSeconds();

            hour = (hour*Math.PI/6) + (minute*Math.PI/(6*60)) + (second*Math.PI/(360*60));
            drawHand(ctx, hour, radius*0.5, radius*0.07);

            minute = (minute*Math.PI/30) + (second*Math.PI/(30*60));
            drawHand(ctx, minute, radius*0.7, radius*0.07);

            second = second*Math.PI/30;
            drawHand(ctx, second, radius*0.9, radius*0.02, 'red');

            // 毎秒コイン生成
            const age = parseInt(localStorage.getItem('userAge')) || 30;
            const fv_per_second = calculateFutureValue(age);
            startCoinAnimation(fv_per_second);
        }

        function drawHand(ctx, pos, length, width, color='black') {
            ctx.beginPath();
            ctx.lineWidth = width;
            ctx.lineCap = "round";
            ctx.strokeStyle = color;
            ctx.moveTo(0,0);
            ctx.rotate(pos);
            ctx.lineTo(0, -length);
            ctx.stroke();
            ctx.rotate(-pos);
        }

        // コインアニメーション
        function startCoinAnimation(valuePerSecond) {
            const coinContainer = document.getElementById('coinContainer');
            const coin = document.createElement('div');
            coin.className = 'coin';
            coin.textContent = `¥${valuePerSecond.toFixed(2)}`; // 1秒あたり価値
            coinContainer.appendChild(coin);

            const offsetX = (Math.random() - 0.5) * 40;
            coin.style.left = `calc(50% + ${offsetX}px)`;

            coin.animate([
                { transform: 'translateY(0)', opacity: 1 },
                { transform: 'translateY(100px)', opacity: 0 }
            ], {
                duration: COIN_FADE_TIME,
                easing: 'ease-out'
            });

            setTimeout(() => {
                coinContainer.removeChild(coin);
            }, COIN_FADE_TIME);
        }

        // ページ初期化
        window.onload = function() {
            const toggle = document.getElementById('ageToggle');
            const savedAge = parseInt(localStorage.getItem('userAge'));

            if (savedAge) {
                hideAgeBox();
            } else {
                showAgeBox();
            }

            document.getElementById('ageInput').value = savedAge || "{{ default_age }}";

            toggle.addEventListener('click', showAgeBox);
            document.getElementById('saveAgeBtn').addEventListener('click', saveAge);

            updateTimeValue(savedAge || 30);
            drawClock();
        };
    </script>
</body>
</html>
