<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>複利時計</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="light-theme">
    <div class="container">
        <!-- 年齢入力ボックス -->
        <div id="ageBox" class="age-box">
            <input type="number" id="ageInput" min="0" max="120" placeholder="年齢を入力">
            <button id="saveAgeBtn">保存</button>

            <!-- テーマ切り替え -->
            <div class="theme-switch">
                <span id="lightBtn" class="theme-btn">□</span>
                <span id="darkBtn" class="theme-btn">■</span>
            </div>
        </div>

        <!-- 右上のトグルボタン -->
        <div id="ageToggle" class="age-toggle">○</div>

        <!-- 現在価値の表示 -->
        <h1 id="timeValue">現在価値: ¥{{ future_value }} / h</h1>

        <!-- 時計 -->
        <div class="clock-wrapper">
            <canvas id="clockCanvas" width="300" height="300"></canvas>
            <div id="coinContainer"></div>
        </div>

        <!-- 合計値の表示 -->
        <h2 id="totalValue">生涯合計: ¥0</h2>
    </div>

    <script>
        const TARGET_AGE = 84;
        const ANNUAL_INTEREST = 0.07;
        const CURRENT_HOURLY_VALUE = 2600;
        const COIN_FADE_TIME = 2000;

        let totalValue = 0; // 生涯合計の値

        // ---------------------------
        // 年齢関連
        // ---------------------------
        function calculateFutureValue(age) {
            const yearsToGo = TARGET_AGE - age;
            const currentPerSecond = CURRENT_HOURLY_VALUE / 3600;
            return currentPerSecond * Math.pow(1 + ANNUAL_INTEREST, yearsToGo);
        }

        function updateTimeValue(age) {
            const fv_per_second = calculateFutureValue(age);
            const fv_per_hour = fv_per_second * 3600;
            document.getElementById('timeValue').textContent =
                `現在価値: ¥${fv_per_hour.toFixed(2)} / h`;
        }

        function updateTotalValue() {
            document.getElementById('totalValue').textContent =
                `生涯合計: ¥${totalValue.toFixed(0)}`;
        }

        function saveAge() {
            const age = parseInt(document.getElementById('ageInput').value);
            if (!isNaN(age) && age > 0 && age < 120) {
                localStorage.setItem('userAge', age);
                updateTimeValue(age);
                initTotalValue(age);
                hideAgeBox();
            } else {
                alert("0~120の有効な年齢を入力してください");
            }
        }

        function showAgeBox() { document.getElementById('ageBox').style.display = 'flex'; }
        function hideAgeBox() { document.getElementById('ageBox').style.display = 'none'; }

        document.addEventListener('click', function(e){
            const ageBox = document.getElementById('ageBox');
            const toggle = document.getElementById('ageToggle');
            if (!ageBox.contains(e.target) && !toggle.contains(e.target)) {
                hideAgeBox();
            }
        });

        // ---------------------------
        // 時計
        // ---------------------------
        function drawClock() {
            const canvas = document.getElementById('clockCanvas');
            const ctx = canvas.getContext('2d');
            const radius = canvas.height / 2;
            ctx.translate(radius, radius);
            setInterval(() => {
                drawFace(ctx, radius);
                drawTime(ctx, radius);
            }, 1000);
        }

        function drawFace(ctx, radius) {
            ctx.clearRect(-radius, -radius, radius*2, radius*2);
            ctx.beginPath();
            ctx.arc(0, 0, radius, 0, 2*Math.PI);
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg-color');
            ctx.fill();
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--text-color');
            ctx.lineWidth = radius*0.05;
            ctx.stroke();

            for (let num=1; num<=12; num++) {
                const ang = num * Math.PI / 6;
                ctx.beginPath();
                const innerRadius = radius*0.88;
                const outerRadius = radius*0.95;
                ctx.moveTo(innerRadius * Math.sin(ang), -innerRadius * Math.cos(ang));
                ctx.lineTo(outerRadius * Math.sin(ang), -outerRadius * Math.cos(ang));
                ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--text-color');
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            ctx.font = radius*0.15 + "px Arial";
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-color');
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            for (let num=1; num<=12; num++) {
                const ang = num * Math.PI / 6;
                ctx.rotate(ang);
                ctx.translate(0, -radius*0.75);
                ctx.rotate(-ang);
                ctx.fillText(num.toString(), 0, 0);
                ctx.rotate(ang);
                ctx.translate(0, radius*0.75);
                ctx.rotate(-ang);
            }
        }

        function drawTime(ctx, radius) {
            const now = new Date();
            let hour = now.getHours() % 12;
            let minute = now.getMinutes();
            let second = now.getSeconds();

            hour = (hour*Math.PI/6) + (minute*Math.PI/(6*60)) + (second*Math.PI/(360*60));
            drawHand(ctx, hour, radius*0.5, radius*0.07);

            minute = (minute*Math.PI/30) + (second*Math.PI/(30*60));
            drawHand(ctx, minute, radius*0.7, radius*0.07);

            second = second*Math.PI/30;
            drawHand(ctx, second, radius*0.9, radius*0.02, 'red');

            const age = parseInt(localStorage.getItem('userAge')) || 30;
            const fv_per_second = calculateFutureValue(age);
            startCoinAnimation(fv_per_second);
            totalValue += fv_per_second;
            updateTotalValue();
        }

        function drawHand(ctx, pos, length, width, color=null) {
            ctx.beginPath();
            ctx.lineWidth = width;
            ctx.lineCap = "round";
            ctx.strokeStyle = color || getComputedStyle(document.body).getPropertyValue('--text-color');
            ctx.moveTo(0,0);
            ctx.rotate(pos);
            ctx.lineTo(0, -length);
            ctx.stroke();
            ctx.rotate(-pos);
        }

        function startCoinAnimation(valuePerSecond) {
            const coinContainer = document.getElementById('coinContainer');
            const coin = document.createElement('div');
            coin.className = 'coin';
            coin.textContent = `¥${valuePerSecond.toFixed(2)}`;
            coinContainer.appendChild(coin);

            const offsetX = (Math.random() - 0.5) * 40;
            coin.style.left = `calc(50% + ${offsetX}px)`;

            coin.animate([
                { transform: 'translateY(0)', opacity: 1 },
                { transform: 'translateY(100px)', opacity: 0 }
            ], {
                duration: COIN_FADE_TIME,
                easing: 'ease-out'
            });

            setTimeout(() => {
                coinContainer.removeChild(coin);
            }, COIN_FADE_TIME);
        }

        function initTotalValue(age) {
            const fv_per_second = calculateFutureValue(age);
            const secondsLived = age * 365.25 * 24 * 3600;
            totalValue = fv_per_second * secondsLived;
            updateTotalValue();
        }

        // ---------------------------
        // テーマ切り替え
        // ---------------------------
        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.remove('light-theme');
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
                document.body.classList.add('light-theme');
            }
            localStorage.setItem('theme', theme);
        }

        // ---------------------------
        // 初期化
        // ---------------------------
        window.onload = function() {
            const toggle = document.getElementById('ageToggle');
            const savedAge = parseInt(localStorage.getItem('userAge'));

            if (savedAge) {
                hideAgeBox();
            } else {
                showAgeBox();
            }

            const age = savedAge || "{{ default_age }}";
            document.getElementById('ageInput').value = age;

            toggle.addEventListener('click', showAgeBox);
            document.getElementById('saveAgeBtn').addEventListener('click', saveAge);

            document.getElementById('lightBtn').addEventListener('click', () => setTheme('light'));
            document.getElementById('darkBtn').addEventListener('click', () => setTheme('dark'));

            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);

            updateTimeValue(age);
            initTotalValue(age);
            drawClock();
        };
    </script>
</body>
</html>
