<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>複利時計</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container">
    <h2>人的資本（1時間あたり）</h2>

    <!-- 初回中央生年月日入力 -->
    <div id="initialBirthdayBox">
        <div class="select-row">
            <select id="yearSelect"></select>
            <select id="monthSelect"></select>
            <select id="daySelect"></select>
        </div>
        <button id="saveInitialBirthdayBtn">保存</button>
        <div class="theme-switch">
            <div id="whiteBtn" class="theme-btn">□</div>
            <div id="blackBtn" class="theme-btn">■</div>
        </div>
    </div>

    <!-- 右上丸ボタン -->
    <div id="birthdayToggle" class="birthday-toggle">○</div>

    <!-- 右上変更用ボックス -->
    <div id="birthdayBox" class="birthday-box">
        <div class="select-row">
            <select id="yearSelect2"></select>
            <select id="monthSelect2"></select>
            <select id="daySelect2"></select>
        </div>
        <button id="saveBirthdayBtn">保存</button>
        <div class="theme-switch">
            <div id="whiteBtn2" class="theme-btn">□</div>
            <div id="blackBtn2" class="theme-btn">■</div>
        </div>
    </div>

    <!-- 人的資本表示 -->
    <h1 id="timeValue">現在価値: ¥0 / h</h1>

    <!-- 総人的資本表示 -->
    <h3 id="totalValue">総人的資本: ¥0</h3>

    <!-- 時計 -->
    <div class="clock-wrapper">
        <canvas id="clockCanvas" width="300" height="300"></canvas>
        <div id="coinContainer"></div>
    </div>
</div>

<script>
// ---------------------------
// 定数
// ---------------------------
const TARGET_AGE = 84;
const ANNUAL_INTEREST = 0.07;
const SECONDS_PER_HOUR = 3600;
const START_AGE = 18;
const DAILY_CONTRIBUTION = 62400;
const COIN_FADE_TIME = 2000;

// ---------------------------
// ユーティリティ
// ---------------------------
function calcAge(birthday){
    const now = new Date();
    let age = now.getFullYear() - birthday.getFullYear();
    let m = now.getMonth() - birthday.getMonth();
    let d = now.getDate() - birthday.getDate();
    if(m<0||(m===0&&d<0)) age--;
    return {years: age, months: m, days: d};
}

function daysBetween(date1, date2){
    return (date2 - date1)/(1000*60*60*24);
}

// ---------------------------
// 人的資本計算
// ---------------------------
function calculateHumanCapital(birthday){
    const now = new Date();
    const futureDate = new Date(birthday.getFullYear()+TARGET_AGE,birthday.getMonth(),birthday.getDate());
    const diffMs = futureDate-now;
    const diffYears = diffMs/(1000*60*60*24*365.25);
    const fullYears = Math.floor(diffYears);
    const extraDays = (diffYears-fullYears)*365.25;
    let value=1;
    value*=Math.pow(1+ANNUAL_INTEREST,fullYears);
    value*=Math.pow(1+ANNUAL_INTEREST/365,extraDays);
    return value*2600;
}

// ---------------------------
// 総人的資本計算
// ---------------------------
function calculateTotalHumanCapital(birthday){
    const startDate=new Date(birthday.getFullYear()+START_AGE,birthday.getMonth(),birthday.getDate());
    const now=new Date();
    let diffDays=daysBetween(startDate,now);
    if(diffDays<0) diffDays=0;
    let total=DAILY_CONTRIBUTION*diffDays;
    total*=Math.pow(1+ANNUAL_INTEREST,diffDays/365);
    return total;
}

// ---------------------------
// 時計描画
// ---------------------------
function drawClock(){
    const canvas=document.getElementById('clockCanvas');
    const ctx=canvas.getContext('2d');
    const radius=canvas.height/2;
    ctx.translate(radius,radius);

    function drawFace(){
        ctx.clearRect(-radius,-radius,radius*2,radius*2);
        ctx.beginPath();
        ctx.arc(0,0,radius,0,2*Math.PI);
        ctx.fillStyle='white';
        ctx.fill();
        ctx.strokeStyle='#333';
        ctx.lineWidth=radius*0.05;
        ctx.stroke();

        for(let num=1;num<=12;num++){
            const ang=num*Math.PI/6;
            ctx.beginPath();
            const innerR=radius*0.88;
            const outerR=radius*0.95;
            ctx.moveTo(innerR*Math.sin(ang),-innerR*Math.cos(ang));
            ctx.lineTo(outerR*Math.sin(ang),-outerR*Math.cos(ang));
            ctx.stroke();
        }

        ctx.font=radius*0.15+'px Arial';
        ctx.textAlign='center';
        ctx.textBaseline='middle';
        for(let num=1;num<=12;num++){
            const ang=num*Math.PI/6;
            ctx.rotate(ang);
            ctx.translate(0,-radius*0.75);
            ctx.rotate(-ang);
            ctx.fillText(num.toString(),0,0);
            ctx.rotate(ang);
            ctx.translate(0,radius*0.75);
            ctx.rotate(-ang);
        }
    }

    function drawHands(){
        const now=new Date();
        let hour=now.getHours()%12;
        let minute=now.getMinutes();
        let second=now.getSeconds();
        hour=(hour*Math.PI/6)+(minute*Math.PI/(6*60))+(second*Math.PI/(360*60));
        drawHand(hour,radius*0.5,radius*0.07);
        minute=(minute*Math.PI/30)+(second*Math.PI/(30*60));
        drawHand(minute,radius*0.7,radius*0.07);
        second=second*Math.PI/30;
        drawHand(second,radius*0.9,radius*0.02,'red');
    }

    function drawHand(pos,length,width,color='black'){
        ctx.beginPath();
        ctx.lineWidth=width;
        ctx.lineCap='round';
        ctx.strokeStyle=color;
        ctx.moveTo(0,0);
        ctx.rotate(pos);
        ctx.lineTo(0,-length);
        ctx.stroke();
        ctx.rotate(-pos);
    }

    setInterval(()=>{
        drawFace();
        drawHands();
        spawnCoin();
    },1000);
}

// ---------------------------
// コイン生成
// ---------------------------
function spawnCoin(){
    const birthday=getSavedBirthday();
    const valuePerHour=calculateHumanCapital(birthday);
    const valuePerSecond=valuePerHour/3600;

    const totalEl=document.getElementById('totalValue');
    let total=parseFloat(totalEl.dataset.total||0);
    total+=valuePerSecond;
    totalEl.dataset.total=total;
    totalEl.textContent='総人的資本: ¥'+total.toFixed(2);

    const coinContainer=document.getElementById('coinContainer');
    const coin=document.createElement('div');
    coin.className='coin';
    coin.textContent='¥'+valuePerSecond.toFixed(2);
    coinContainer.appendChild(coin);

    coin.style.left=(Math.random()-0.5)*40+'px';
    coin.animate([{transform:'translateY(0)',opacity:1},{transform:'translateY(100px)',opacity:0}],
        {duration:2000,easing:'ease-out'});
    setTimeout(()=>coinContainer.removeChild(coin),2000);
}

// ---------------------------
// 生年月日保存
// ---------------------------
function getSavedBirthday(){
    const val=localStorage.getItem('userBirthday');
    if(val) return new Date(val);
    return null;
}

function saveBirthday(yearSel,monthSel,daySel,boxId){
    const y=parseInt(yearSel.value);
    const m=parseInt(monthSel.value)-1;
    const d=parseInt(daySel.value);
    const birthday=new Date(y,m,d);
    localStorage.setItem('userBirthday',birthday);
    updateValues();
    document.getElementById(boxId).style.display='none';
}

// ---------------------------
// □■ボタンテーマ切替
// ---------------------------
function setupTheme(whiteBtn,blackBtn){
    whiteBtn.addEventListener('click',()=>{document.body.style.setProperty('--bg-color','white');document.body.style.setProperty('--text-color','black');});
    blackBtn.addEventListener('click',()=>{document.body.style.setProperty('--bg-color','black');document.body.style.setProperty('--text-color','white');});
}

// ---------------------------
// UI操作
// ---------------------------
document.getElementById('birthdayToggle').addEventListener('click',()=>{
    const box=document.getElementById('birthdayBox');
    box.style.display=(box.style.display==='flex')?'none':'flex';
});

document.addEventListener('click',e=>{
    const box=document.getElementById('birthdayBox');
    const toggle=document.getElementById('birthdayToggle');
    if(!box.contains(e.target)&&!toggle.contains(e.target)) box.style.display='none';
});

// ---------------------------
// 初期化
// ---------------------------
function populateSelects(selectId,yearMax=2025){
    const yearSel=document.getElementById(selectId+'Year');
    const monthSel=document.getElementById(selectId+'Month');
    const daySel=document.getElementById(selectId+'Day');
    for(let y=1900;y<=yearMax;y++) yearSel.add(new Option(y,y));
    for(let m=1;m<=12;m++) monthSel.add(new Option(m,m));
    for(let d=1;d<=31;d++) daySel.add(new Option(d,d));
}

// ---------------------------
// 値更新
// ---------------------------
function updateValues(){
    const birthday=getSavedBirthday();
    if(!birthday) return;
    const valuePerHour=calculateHumanCapital(birthday);
    document.getElementById('timeValue').textContent='現在価値: ¥'+valuePerHour.toFixed(2)+' / h';
    const total=calculateTotalHumanCapital(birthday);
    const totalEl=document.getElementById('totalValue');
    totalEl.dataset.total=total;
    totalEl.textContent='総人的資本: ¥'+total.toFixed(2);

    // 右上セレクトに反映
    document.getElementById('yearSelect2').value=birthday.getFullYear();
    document.getElementById('monthSelect2').value=birthday.getMonth()+1;
    document.getElementById('daySelect2').value=birthday.getDate();
}

// ---------------------------
// ページロード
// ---------------------------
window.onload=function(){
    const birthday=getSavedBirthday();
    if(birthday){
        document.getElementById('initialBirthdayBox').style.display='none';
    }
    populateSelects('yearSelect');
    populateSelects('monthSelect');
    populateSelects('daySelect');
    populateSelects('yearSelect2');
    populateSelects('monthSelect2');
    populateSelects('daySelect2');

    setupTheme(document.getElementById('whiteBtn'),document.getElementById('blackBtn'));
    setupTheme(document.getElementById('whiteBtn2'),document.getElementById('blackBtn2'));

    if(birthday) updateValues();
    drawClock();

    document.getElementById('saveInitialBirthdayBtn').addEventListener('click',()=>{saveBirthday(document.getElementById('yearSelect'),document.getElementById('monthSelect'),document.getElementById('daySelect'),'initialBirthdayBox');});
    document.getElementById('saveBirthdayBtn').addEventListener('click',()=>{saveBirthday(document.getElementById('yearSelect2'),document.getElementById('monthSelect2'),document.getElementById('daySelect2'),'birthdayBox');});
};
</script>
</body>
</html>
